<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Compare Pokémon</title>
  <link rel="stylesheet" href="stylecompare.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js for stats -->
</head>
<body>
  <button type="button" class="back-btn" onclick="window.location.href='index.html';">Back to Home</button>
  <h1>Compare Pokémon</h1>

  <div>
    <input type="text" id="pokemon1" placeholder="First Pokémon" oninput="showSuggestions('pokemon1')" autocomplete="off">
    <div id="suggestions-pokemon1" class="suggestions"></div>
  </div>

  <div>
    <input type="text" id="pokemon2" placeholder="Second Pokémon" oninput="showSuggestions('pokemon2')" autocomplete="off">
    <div id="suggestions-pokemon2" class="suggestions"></div>
  </div>

  <button type="button" onclick="comparePokemon()">Compare</button>

  <div id="comparisonResult"></div>

  <script>
    let allPokemon = [];

    // Load all Pokémon names once
    fetch('https://pokeapi.co/api/v2/pokemon?limit=1000')
      .then(res => res.json())
      .then(data => {
        allPokemon = data.results.map(p => p.name);
      });

    function showSuggestions(inputId) {
      const input = document.getElementById(inputId);
      const query = input.value.toLowerCase();
      const suggestions = allPokemon.filter(name => name.startsWith(query)).slice(0, 10);
      const suggestionBox = document.getElementById(`suggestions-${inputId}`);
      suggestionBox.innerHTML = '';

      suggestions.forEach(name => {
        const div = document.createElement('div');
        div.textContent = name;
        div.onclick = () => {
          input.value = name;
          suggestionBox.innerHTML = '';
        };
        suggestionBox.appendChild(div);
      });

      if (query === '') suggestionBox.innerHTML = '';
    }

    async function fetchPokemonData(name) {
      const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${name.toLowerCase()}`);
      if (!res.ok) throw new Error(`${name} not found`);
      return await res.json();
    }

    async function comparePokemon() {
      const name1 = document.getElementById('pokemon1').value.trim().toLowerCase();
      const name2 = document.getElementById('pokemon2').value.trim().toLowerCase();
      const container = document.getElementById('comparisonResult');
      container.innerHTML = '';

      try {
        const [p1, p2] = await Promise.all([fetchPokemonData(name1), fetchPokemonData(name2)]);

        const statLabels = ["HP", "Attack", "Defense", "Sp. Atk", "Sp. Def", "Speed"];
        const getStat = (data, statName) => {
          const found = data.stats.find(s => s.stat.name.includes(statName.toLowerCase()));
          return found ? found.base_stat : "-";
        };

        const getEVYield = (data, statName) => {
          const found = data.stats.find(s => s.stat.name.includes(statName.toLowerCase()));
          return found && found.effort > 0 ? `${found.effort} EV` : "-";
        };

        const getAbilities = (data) => {
          return data.abilities.map(a => a.ability.name).join(', ');
        };

        const getTypes = (data) => {
          return data.types.map(t => t.type.name).join(', ');
        };

        let table = `
          <table>
            <tr style="background:#ffcb05;">
              <th>Stat</th>
              <th>${p1.name.toUpperCase()}</th>
              <th>${p2.name.toUpperCase()}</th>
            </tr>
        `;

        statLabels.forEach(label => {
          const statKey = label.toLowerCase().replace(/\s/g, '');
          table += `
            <tr>
              <td><strong>${label}</strong></td>
              <td>${getStat(p1, statKey)} (${getEVYield(p1, statKey)})</td>
              <td>${getStat(p2, statKey)} (${getEVYield(p2, statKey)})</td>
            </tr>
          `;
        });

        table += `</table>`;

        const chartData = {
          labels: statLabels,
          datasets: [
            {
              label: p1.name.toUpperCase(),
              data: statLabels.map(label => getStat(p1, label.toLowerCase())),
              backgroundColor: 'rgba(255, 204, 5, 0.6)',
              borderColor: 'rgba(255, 204, 5, 1)',
              borderWidth: 1
            },
            {
              label: p2.name.toUpperCase(),
              data: statLabels.map(label => getStat(p2, label.toLowerCase())),
              backgroundColor: 'rgba(42, 117, 187, 0.6)',
              borderColor: 'rgba(42, 117, 187, 1)',
              borderWidth: 1
            }
          ]
        };

        container.innerHTML = `
          <div class="comparison-container">
            <div class="pokemon-info">
              <img src="${p1.sprites.front_default}" alt="${p1.name}" style="max-width: 120px;">
              <p><strong>Type:</strong> ${getTypes(p1)}</p>
              <p><strong>Abilities:</strong> ${getAbilities(p1)}</p>
            </div>
            <div class="pokemon-info">
              <img src="${p2.sprites.front_default}" alt="${p2.name}" style="max-width: 120px;">
              <p><strong>Type:</strong> ${getTypes(p2)}</p>
              <p><strong>Abilities:</strong> ${getAbilities(p2)}</p>
            </div>
            <div class="chart-container">
              <canvas id="statComparisonChart"></canvas>
            </div>
          </div>
          ${table}
        `;

        const ctx = document.getElementById('statComparisonChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: chartData,
          options: {
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 50
                }
              }
            },
            responsive: true,
            maintainAspectRatio: false
          }
        });

      } catch (err) {
        container.innerHTML = `<p style="color:red;">${err.message}</p>`;
      }
    }
  </script>
</body>
</html>
